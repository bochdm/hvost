<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout">

  <head>
    <title>Статьи</title>
    <meta content='all' name='robots'/>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'/>
    <meta content='width=device-width, initial-scale=1.0' name='viewport'/>

  </head>
  <body>
    <div id='wrapper'>

      <main  layout:fragment="content">

      <div id='main' role='main'>
        <div id='main-content-header'>
          <div class='container'>
            <div class='row'>
              <div class='col-sm-12'>
                <h1 class='title'>
                  Карта активного гражданина
                </h1>
                <ol class='breadcrumb'>
                  <li>
                    <a href='index.html'>
                      <i class='fa-icon-home'></i>
                    </a>
                  </li>
                  <li class='active'>Карта вопросов</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <div id="main-content">
          <div class='container'>
            <div class="row">
              <div class="col-sm-12">
                <div id='map-canvas' style="height: 600px;"></div>
              </div>
            </div>

            <div class='row' id="askme">
              <form id="send-question" th:action="@{/activepeople/addquestion}" th:object="${question}"
                    class='form dropzone' method='post' enctype="multipart/form-data"
                    style="border:none;background-color: transparent;">
                <div class='page-header page-header-with-icon'>
                  <i class='fa-icon-question-sign'></i>
                  <h2>Не смогли найти ответ? Задайте&nbsp;свой&nbsp;вопрос!</h2>
                </div>
                <div class='col-sm-6'>
                  <fieldset>
                    <div class='row'>
                      <div class='col-sm-6'>
                        <div class='form-group'>
                          <input class='form-control' th:field="*{author}" data-rule-required='false' id='author' name='author' placeholder='Ваше имя' type='text'/>
                        </div>
                      </div>
                      <div class='col-sm-6'>
                        <div class='form-group'>
                          <input class='form-control' id='contact_email'
                                 name='contact_email' placeholder='Ваш E-Mail' type='email'/>
                        </div>
                      </div>
                    </div>
                    <div class="row">
                      <div class='col-sm-12'>
                        <div class='form-group control-group'>
                          <input class='form-control' data-rule-email='false' data-rule-required='false' id='address' name='address' placeholder='Адрес' type='text'/>
                        </div>
                      </div>
                    </div>
                    <div class='row'>
                      <div class='col-sm-12'>
                        <div class='form-group'>
                          <textarea class='form-control' id='questionText' name='text_question' placeholder='Ваш вопрос...' rows='14' th:field="*{questionText}"/>
                          <td th:if="${#fields.hasErrors('questionText')}" class="text-danger" th:errors="*{questionText}">Name Error</td>
                        </div>
                      </div>
                    </div>
                    <div class='row'>
                      <div class='col-sm-12'>
                        <button id="newQuestion" name="newQuestion" class='btn btn-contrast btn-block' type="button" th:text="#{ask.question}"/>
                      </div>
                    </div>
                  </fieldset>

                </div>
                <div class="col-sm-6">
                  <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="x_panel">
                      <div class="x_content">

                        <p>Перенесите файлы изображений в область ниже или кликните на ней</p>
                        <div id="dropzonePreview" class="dz-default dz-message form-control" style="height: 430px; ">
                          <div id="preview">
                            <span class="preview"><img data-dz-thumbnail="" /></span>
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class='fade' id='scroll-to-top'>
          <i class='fa-icon-chevron-up'></i>
        </div>
      </div>
      </main>
    </div>

    <th:block layout:fragment="script">

      <script th:src="@{http://maps.googleapis.com/maps/api/js?language=ru}" type="text/javascript"></script>

      <script type="text/javascript">
        /*<![CDATA[*/
//        var unaswered = /*[[${#vars['unaswered']}]]*/
        var unaswered = /*[[${unaswered}]]*/
        console.log(unaswered);


        var initializeMap;

        initializeMap = function() {

          var iw1, latlng, marker, options;

          latlng = new google.maps.LatLng(59.843574, 30.193437);
          options = {
            scrollwheel: false,
            zoom: 13,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl: true,

          };

          map = new google.maps.Map(document.getElementById("map-canvas"), options);

/*          marker = new google.maps.Marker({
            position: latlng,
            map: map
          });

          iw1 = new google.maps.InfoWindow({
            content: "Here we are!"
          });

          return google.maps.event.addListener(marker, "click", function(e) {
            return iw1.open(map, this);
          });*/
        };

        google.maps.event.addDomListener(window, 'load', initializeMap);

      /*]]>*/
    </script>

      <script th:inline="javascript">
        var timer = setInterval(function (){
          console.log("unasweredcheck setInterval");
          $.ajax({
            type: 'GET',
            url: 'map/unansweredcheck',
            dataType: 'text',
           /* beforeSend: function(){
              $('#tweets').html('<p class="text-center"><img th:src="@{/resources/img/ajax-loader.gif}"/></p>');
            },*/

            success: function(data){
              if (data.length > 0) {
                var json_x = $.parseJSON(data);
                $.each(json_x, function (i, value) {
                  var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(value.lat,value.lng),
                    title: 'lalalla',
                    map:map
                  });
                  var info = new google.maps.InfoWindow({
                    content: value.text
                  });
                  marker.addListener('click', function() {
                    info.open(map, marker);
                  });
                  info.addListener('click', function(){
                     console.log("click on info");
                  });

                });
                clearInterval(timer);
              }

            /*  if (data.length > 0){
                $('#tweets').html(data);
                console.log("ajax COMPLETE");
                clearInterval(timer);
              }*/
            }
          });
        }, 3000);

      </script>

      <script th:inline="javascript">
        var timer = setInterval(function (){
          console.log("answeredcheck setInterval");
          $.ajax({
            type: 'GET',
            url: 'map/answeredcheck',
            dataType: 'text',
            /* beforeSend: function(){
             $('#tweets').html('<p class="text-center"><img th:src="@{/resources/img/ajax-loader.gif}"/></p>');
             },*/

            success: function(data){
              if (data.length > 0) {
                var json_x = $.parseJSON(data);
                $.each(json_x, function (i, value) {
                  var marker = new google.maps.Marker({
                    icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    position: new google.maps.LatLng(value.lat,value.lng),
                    title: 'lalalla',
                    map:map
                  });
                  var info = new google.maps.InfoWindow({
                    content: value.text
                  });
                  marker.addListener('click', function() {
                    info.open(map, marker);
                  });
                });
                clearInterval(timer);
              }

              /*  if (data.length > 0){
               $('#tweets').html(data);
               console.log("ajax COMPLETE");
               clearInterval(timer);
               }*/
            }
          });
        }, 3000);

      </script>

    </th:block>

  </body>
</html>
